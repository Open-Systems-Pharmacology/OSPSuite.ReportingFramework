---
title: "PK Parameters"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{PK Parameters}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  markdown: 
    wrap: 72
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  comment = "#>"
)
```

```{r setup, echo = FALSE}
library(ospsuite.reportingframework)
library(data.table)
```

## Calculate PK Parameters for Scenarios

This vignette provides an overview of how to calculate and visualize pharmacokinetic (PK) parameters for different scenarios using the functions available in the `ospsuite.reportingframework` package.




## Import Observed Data

Before running the analysis, you need to import the observed PK data. This can be done using a data.table containing the relevant observed parameters, which can then be compared against simulated data.

## Available Plot Types

### Overview of Plot Types

```{r, echo = FALSE}
# Create a data frame for the plot types overview
plotTypes <- rbind(
  data.table(
    Plot_Type = "[**Box-whisker plots**](#box-whisker-plots)",
    Objective = "Display and compare distributions of different scenarios.",
    Simulated_Data = "Displayed are percentiles as box-whiskers.",
    Observed_Data = "",
    Numeric_Values = "Tables containing the numeric values are exported additionally to each plot as CSV.",
    Data_Types = "Absolute values and ratios of crossover studies."
  ),
  data.table(
    Plot_Type = "[**Forest plots of aggregated distributions**](#forest-plots)",
    Objective = "Compare aggregated distributions of different scenarios. Compare observed data with simulated values.",
    Simulated_Data = "Displayed is point and range (e.g., geometric mean and geometric standard deviation).",
    Observed_Data = "Aggregated data can be added as point range.",
    Numeric_Values = "Tables containing the numeric values are optionally displayed.",
    Data_Types = "Absolute values and ratios of crossover studies."
  ),
  data.table(
    Plot_Type = "[**Forest plots of point estimators**](#forestestimator)",
    Objective = "Compare point estimators (e.g., DDI Ratios) of different scenarios. Compare observed data with simulated values.",
    Simulated_Data = "Estimator is displayed as a point.",
    Observed_Data = "Aggregated data can be added as point range.",
    Numeric_Values = "Tables containing the numeric values are optionally displayed.",
    Data_Types = "Absolute values, ratios of crossover studies, and ratios of scenarios if different studies."
  ),
  data.table(
    Plot_Type = "[**Histograms**](#histograms)",
    Objective = "Display and compare distributions of different scenarios.",
    Simulated_Data = "Displayed is the distribution as a histogram.",
    Observed_Data = "",
    Numeric_Values = "",
    Data_Types = "Absolute values and ratios of crossover studies."
  ),
  data.table(
    Plot_Type = "[**Range plots**](#rangeplots)",
    Objective = "Display dependence of PK parameters vs. population parameters (e.g., age).",
    Simulated_Data = "Displayed is aggregated distribution per bin of population parameter.",
    Observed_Data = "",
    Numeric_Values = "Exported are the aggregated values per bin.",
    Data_Types = "Absolute values and ratios of crossover studies."
  )
)

# Print the table using kable
knitr::kable(plotTypes,
  format = "markdown", escape = FALSE, align = "l",
  col.names = gsub("_", " ", names(plotTypes))
)
```

#### Box-whisker plots {#box-whisker-plots}

Box-whisker plots provide a visual representation of the distribution of PK parameters across different scenarios. Default percentiles are set to 0.05, 0.25, 0.5, 0.75, and 0.95. Data outliers can be added as points. Additionally, tables containing the number of individuals, percentiles, mean, standard deviation (SD), geometric mean, geometric SD, and geometric coefficient of variation (CV) of the simulated data are exported alongside each plot.

To generate these plots use plotfunction `plotPKBoxwhisker` as input for the `runPlot` function.

#### Forest plots of aggregated distributions {#forest-plots}

Forest plots allow for the comparison of aggregated distributions of different scenarios. The estimator for mean and range can be selected, with available options including arithmetic mean and standard deviation; geometric mean and standard deviation; and custom functions. This functionality is particularly useful for visualizing how simulated data aligns with observed data, enhancing the interpretability of PK parameter estimates.

To generate these plots use plotfunction `plotPKForestAggregatedAbsoluteValues` or `plotPKForestAggregatedRatios` as input for the `runPlot` function.

#### Forest plots of estimators {#forestestimator}

Forest plots of estimators provide a means to compare point estimators (e.g., DDI Ratios) across different scenarios. These plots can include observed data, allowing for a direct comparison between simulated and actual outcomes. The estimators are displayed as points, with confidence intervals represented as ranges. The confidence interval reflect the uncertainty based on the number of the simulated individuals. It reflects not the model uncertainty. 

In addition to the point estimates and their confidence intervals, the precision watermark is an important feature of these plots. The precision watermark indicates whether the precision requirements for the displayed estimates have been met. 

**Mechanism Behind the Precision Watermark:**
- The precision is calculated based on the relationship between the estimated values (xValues) and their corresponding minimum (xMin) and maximum (xMax) confidence interval bounds.
- If the calculated precision falls below a predefined threshold (e.g., 0.01), the watermark is activated, displaying a warning label such as "Outside precision requirement" on the plot. The threshold is set by the option "OSPSuite.RF.RequiredPrecisison"
- This alert serves to inform users that the estimates may not be reliable due to insufficient sample sizes or high variability in the data, prompting them to consider increasing the sample size for improved precision.

By including the precision watermark, users are better equipped to assess the reliability of the point estimates and make informed decisions based on the visualized data.

To generate these plots use plotfunction `plotPKForestPointEstimateOfAbsoluteValues` or `plotPKForestPointEstimateOfRatios`
as input for the `runPlot` function.

#### Histograms of distributions {#histograms}

Histograms display the distribution of PK parameters for different scenarios. By visualizing the frequency of parameter values, histograms provide insights into the underlying distribution shapes, such as normality or skewness, which are critical for statistical analysis and interpretation.

To generate these plots use plotfunction `plotHistograms` as input for the `runPlot` function.

#### Range plots {#rangeplots}

Range plots illustrate the dependence of PK parameters on population parameters, such as age. Aggregated distributions are displayed per bin of population parameters, allowing for the identification of trends and patterns. Exported are the aggregated values per bin, which can be useful for further statistical analysis and reporting. Data types include both absolute values and ratios of crossover studies, providing a comprehensive view of the relationships between parameters.

To generate these plots use plotfunction `plotDistributionVsDemographics` as input for the `runPlot` function.





