---
title: "TimeProfilePlots"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{TimeProfilePlots}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, echo=FALSE}
library(ospsuite.reportingframework)
library(data.table)
```

# Time Profile Plots

## Introduction 

The plotTimeProfilePanels function is a powerful utility designed to generate a series of time profile plots as facet panels from your data. This function simplifies the process of visualizing complex time-dependent data by allowing you to create multiple plots organized in a user-defined layout.

This function primarily focuses on simulated scenarios, with each panel displaying the result of one scenario. Plots containing more than one scenario or only observed data are not supported by this function.

By utilizing an Excel configuration sheet, plotTimeProfilePanels reads various parameters, such as scenarios, time ranges, and output paths, to produce informative and visually appealing plots. The function supports faceting, enabling you to display different subsets of your data side by side, enhancing comparative analysis.

This function is particularly useful for researchers and analysts who need to visualize concentration-time profiles of various scenarios, compare predicted versus observed data, and analyze residuals cohesively. With options for customizing plot aesthetics and layouts, plotTimeProfilePanels provides a comprehensive solution for time profile visualization.

For a more comprehensive understanding of time profile plotting, including setting up your project and analyzing data, please refer to the Time Profile Plotting Tutorial.

## Calling the `plotTimeProfilePanels` Function via `runPlot`

The `plotTimeProfilePanels` function can be invoked through the `runPlot` interface, allowing for a standardized way to generate time profile plots. This approach ensures that your plots are created with the necessary configurations and observed data.

### Function Overview

#### Usage

```{r, echo=TRUE,eval=FALSE}
runPlot(
  functionKey = "TimeProfile_Panel",
  projectConfiguration = projectConfiguration,
  inputs = list(
    configTableSheet,
    dataObserved,
    nFacetColumns = 2,
    nMaxFacetRows = 4,
    facetAspectRatio = 0.5,
    aggregationFlag = c("GeometricStdDev", "ArithmeticStdDev", "Percentiles", "Custom"),
    percentiles = c(5, 50, 95),
    referenceScaleVector = list(
      Control = c(NA, NA),
      Reference = c(NA, NA)
    )
  )
)
```

#### Parameters

- *functionKey:*  This parameter is used to select the plotfunction, its sets the subfolder of the outputFolder, where the created plots are saved to the selected "sheetName"

- *projectConfiguration:* An object containing the project settings, including file paths and scenario definitions. This is essential for the function to access the necessary data.

- *configTableSheet:* The name of the sheet in the Excel plot configuration file that defines the plot settings. See details below.

- *dataObserved:* The observed data to be plotted. This can be provided in data.table format or as a DataCombined object (which will be converted internally).

- *nFacetColumns:* The maximum number of facet columns (default is 2) used for the facet type "by Order". This controls how many columns will be displayed in the plot.

- *nMaxFacetRows:* The maximum number of facet rows (default is 4) used for all facet types. This controls how many rows will be displayed in one plot. If the plot configuration leads to more rows, the plot wil be split in different plots.

- *facetAspectRatio:* The aspect ratio for the facets (default is 0.5). This controls the height-to-width ratio of the individual plots.

- *aggregationFlag:* The type of aggregation function to use for simulated data (default is "GeometricStdDev"). Options include:

  - "GeometricStdDev"  Mean will be the geometric mean, range is defined by the geometric standard-deviation
  - "ArithmeticStdDev" Mean will be the arithmetic mean, range is defined by the arithmetic standard-deviation
  - "Percentiles"  mean and range are defined by the percentiles input parameter
  - "Custom"  the custom function provided by parameter is used for aggregation

- *percentiles:* A numeric vector of percentiles to consider if the aggregation method is set to "Percentiles" (default is c(5, 50, 95)).

- *customFunction:* Optional custom function for aggregation.

A custom function should take a numeric vector `y` as input and return a list containing:  

 - `yValues`: The aggregated value (e.g., mean).
 - `yMin`: The lower value of the aggregated data, (e.g. mean - sd).
 - `yMax`: The upper value of the aggregated data, (e.g. mean + sd).
 - `yErrorType`: A string indicating the type of error associated with the aggregation,
 it is used in plot legends and captions.
 It must be a concatenation of the descriptor of yValues and the descriptor of yMin - yMax range
 separated by "|" (e.g., "mean | standard deviation" or "median | 5th - 95th percentile").

- *referenceScaleVector:* A named list which configures labels and colors for the display of reference scenarios.
 The names of the list are displayed as labels in the legend, the first entry defines the aesthehtic color, the second entry defines the aesthetic fill. E.g. referenceScaleVector = list(DDI = c('darkred', 'red'), Control = c('darkblue', 'blue')) would label the 'Scenario' with 'DDI' and color it red the 'ReferenceScenario' would be labeled as 'Control' and displayed in blue, with dark colors for the aesthetic color and light colors for the aesthetic fill.  If the colors are set to NA, default colors are selected for the Scenario and the reference is displayed in grey.

## Adding Default Configuration for Time Profile Plots

The addDefaultConfigForTimeProfilePlots function is a helpful utility designed to streamline the process of setting up your Excel configuration sheet for time profile plots. This function automatically populates a new sheet with default values that you can customize according to your needs.

### Function Overview

#### Purpose

The primary purpose of the addDefaultConfigForTimeProfilePlots function is to create a new configuration sheet in your Excel workbook that contains standardized settings for time profile plots. This is especially useful for users who are starting from scratch or want to ensure consistency across multiple plots.

#### Parameters

- *projectConfiguration:* This parameter takes an object that contains the project settings, including file paths and scenario definitions. It is essential for the function to access the necessary data for populating the configuration sheet.

- *sheetName:* This is the name of the sheet that will be created in the Excel workbook. If a sheet with the same name already exists and the overwrite parameter is set to FALSE, the function will stop execution.

- *overwrite:* A boolean value that indicates whether to overwrite an existing sheet with the same name. If set to TRUE, the function will replace the existing sheet; if FALSE, it will raise an error if the sheet already exists.

### How It Works

1. Loading the Workbook: The function first loads the existing Excel workbook specified in the projectConfiguration.

2. Checking for Existing Sheets: It checks if a sheet with the specified sheetName already exists. If it does and overwrite is FALSE, the function stops execution.

3. Fetching Scenario and Output Path Data: The function retrieves the scenario definitions and output path IDs from the project configuration, which are necessary for populating the new sheet.

4. Creating Default Headers and Configuration:

The function initializes a header row with a title (e.g., "Concentration Time Profiles").
It generates default configuration entries for each scenario, including: 

- PlotName
- Scenario
- ScenarioCaptionName
- OutputPathIds
- TimeUnit
- TimeOffset
- TimeRange settings
- yScale
- FacetType
- Plotting flags (e.g., Plot_TimeProfiles, Plot_PredictedVsObserved)

If the DefaultScenario in the "DataGroups" sheet of the plot configuration is filled, the column "DataGroupIds" is filled accordingly.

5. Saving the Workbook: Finally, the function saves the workbook, ensuring that the new configuration sheet is stored for future use.

### Example Usage

Hereâ€™s an example of how to use the addDefaultConfigForTimeProfilePlots function:

```{r, echo=TRUE,eval=FALSE}
# Assuming projectConfiguration is already defined
addDefaultConfigForTimeProfilePlots(
  projectConfiguration = projectConfiguration,
  sheetName = "TimeProfiles",
  overwrite = TRUE
)
```

In this example, a new sheet named "TimeProfiles" will be created (or overwritten if it already exists) in the specified Excel workbook, populated with default settings for time profile plots.
If the parameter `overwrite`is set to `FALSE`only scenarios are added which are not yet included.

### Conclusion

The `addDefaultConfigForTimeProfilePlots` function is an invaluable tool for users looking to streamline the process of creating time profile plot configurations. By automatically populating an Excel sheet with default values, it saves time and ensures consistency across your plotting efforts. 


## Filling the Excel Configuration Sheet for Time Profile Panels

### Introduction
This section guides you through filling out the Excel configuration sheet required for generating time profile panels using the `plotTimeProfilePanels` function in R. The configuration sheet includes several columns, each serving a specific purpose in defining the plots.

### Excel Sheet Structure
Your Excel sheet should have the following columns:

#### Heading Columns
These columns define the structure and hierarchy of your report.

- *Level:* Specifies the header level for the plot sections. Use numeric values to indicate the hierarchy (e.g., 1 for main headers, 2 for sub-headers).

- *Header:* The title of the section or plot. This will be displayed in the generated report.

#### Plot Configuration Columns

These columns provide the essential information required to generate the plots.
- *PlotName:* A unique identifier for each plot. 
All rows with the same 'PlotName' will be exported in one plot with different panels and one plot caption.

- *Scenario:* The name of the scenario being plotted. This should match the scenario names defined in your project. In this plot type only one scenario per panel is possible.

#### Data Grouping Columns

- *OutputPathIds:* The IDs of the output paths that will be plotted. Ensure that these IDs are defined in your project. If you want to include multiple output paths, you can list them separated by commas. For example: OutputPath1, OutputPath2, OutputPath3 leads to 3 Panels in the plot. For each Output a new panel will be generated. You can also use parentheses to group output paths. The brackets indicate that the enclosed paths should be plotted into one panel. For example: (OutputPath1, OutputPath2),OutputPath3 leads to two panels.

- *DataGroupIds:* IDs for the data groups to be included in the plot. These should match the data groups defined in your project. If you want to include multiple data groups, you can list them separated by commas. All groups will be added in the same panel

- *IndividualIds:* IDs for the individuals to be included in the plot. 
The columns is used a s filter for data group and scenario simulation, if your scenario is a virtual twin scenario (see the vignette for the `ospsuite.reportingframework` package, topic 'Simulation_setup', section 'Populations').
It is possible to list more then one individual separated by ",". If you want to plot all individuals you can use "\*" as short cut. For all plots except the 'Plot_TimeProfiles' you can enclose IndividualIds with a bracket, to plot them in one panel. For the shortcut that would be '(*)'.

#### Caption and Output Columns

- *ScenarioCaptionName*: A descriptive name for the scenario that will appear in the plot captions.

- *PlotCaptionAddon:* Any additional text you want to include in the plot captions.


#### Additional Plot Configuration Columns

- *TimeUnit:* The unit of time for the x-axis (e.g., "h" for hours, "day(s)" for days).
  This unit is valid for all time columns like Timeoffset or Time range.

- *TimeOffset:* The time offset to be applied to the x-values. This is often set to 0 unless specific adjustments are needed.

- *ReferenceScenario:* Indicates whether a reference scenario is used in the plot. This should be a logical value (TRUE/FALSE).

- *TimeOffset_Reference:* The time offset for the reference scenario.

- *yScale:* Defines the scale of the y-axis. Options include "linear" or "log" or "linear,log" then plots for both scales are generated.

- *ylimit_linear* and *ylimit_log:* The limits for the y-axis in linear(log) scale . This should be an R readable string which evaluates to a numeric vector of length 2 (e.g "c(0,100)" or "c(0,NA)" if only a lower limit is needed). 
The function will stop with an error if observed data are outside the limits. Please use a filtered data set if you want to zoom in.

#### Facet Columns:


- *FacetType:*  Defines how the plots will be faceted. Options are: 

- "by Order":  number of facet columns is determined by the input parameter `nFacetCOlumns` of `plotTimeProfilePanels()`
- "vs Output": number of facet columns is determined by the number of outputs.
- "vs TimeRange": Normally For each time range a separate plot is generated. With this option you can compare different time ranges in one plot. E.g. First dose vs steady state. 


- *FacetScale:* Determines the scaling of facets. Options include "fixed", "free", "free_x", and "free_y". This is used as input for `ggplot2::facet_wrap`

#### Time range columns

This are all columns which start with "TimeRange_". Per default 3 columns are given, but you can add new ones or delete some. For each scenario at least one has to be non empty.

The input has to be  an R expression which evaluates to a numeric vector of length 2 ( e.g. c(0,24)) A time Unit the unit given in column timeUnit is used)  or one of the predefined strings: "total", "firstApplication", or "lastApplication".

The default columns are 
- *TimeRange_total:* Specifies the time range for the entire plot

- *TimeRange_firstApplication:* Specifies the time range for the first application.

- *TimeRange_lastApplication:* Specifies the time range for the last application.

Each time range columns needs a corresponding row in the excel sheet "TimeRange".
Here you can customize the caption text and the time label.


#### Plot type selection

A logical value indicating whether to generate selected plotType:

- *Plot_TimeProfiles*

- *Plot_PredictedVsObserved*

- *Plot_ResidualsAsHistogram*

- *Plot_ResidualsVsTime*

- *Plot_ResidualsVsObserved*



### Example Configuration
Here is an example of how the first few rows of your Excel sheet might look:



```{r load-template, eval=TRUE, echo=FALSE}
templateFilePath <- system.file("templates", "Plots.xlsx",
  package = "ospsuite.reportingframework", mustWork = TRUE
)

dtPlots <-
  xlsxReadData(
    wb = templateFilePath,
    sheet = "TimeProfile_Panel",
    skipDescriptionRow = TRUE,
    emptyAsNA = FALSE,
    convertHeaders = FALSE
  )

```

```{r example-table, echo=FALSE,eval=TRUE}
dtPlots <- dtPlots[c()]

dtPlots <- rbind(dtPlots,
  data.table(
    PlotName = rep(c("Plot_1", "Plot_2"), each = 3),
    Scenario = paste("study_123", seq(1, 6)),
    ScenarioCaptionName = paste("Study 123", seq(1, 6)),
    PlotCaptionAddon = rep(c("Single dose studies", "multi dose studies", each = 3)),
    DataGroupIds = paste("study_123", seq(1, 6)),
    OutputPathIds = "plasma_parent, plasma_etabolite",
    TimeUnit = "h",
    TimeOffset = 0,
    ReferenceScenario = FALSE,
    TimeOffset_Reference = 0,
    TimeRange_total = "total",
    TimeRange_firstApplication = rep(c("", "firstApplication"), each = 3),
    TimeRange_lastApplication = rep(c("", "lastApplication"), each = 3),
    YScale = "linear,log",
    Ylimit_linear = rep(c(""), each = 6),
    Ylimit_log = rep(c(""), each = 6),
    FacetType = FACETTYPE$byOrder,
    FacetScale = "fixed",
    Plot_TimeProfiles = rep(c("TRUE"), each = 6),
    Plot_PredictedVsObserved = rep(c("TRUE"), each = 6),
    Plot_ResidualsAsHistogram = rep(c("FALSE"), each = 6),
    Plot_ResidualsVsTime = rep(c("FALSE"), each = 6),
    Plot_ResidualsVsObserved = rep(c("FALSE"), each = 6),
    PlotInputs_TP = rep(c(""), each = 6)
  ),
  fill = TRUE
)

dtPlots2 <- data.table::copy(dtPlots)
dtPlots2$Scenario <- paste("study_456", seq(1, 6))
dtPlots2$ScenarioCaptionName <- paste("Study 456", seq(1, 6))
dtPlots2$PlotName <- rep(c("Plot_3", "Plot_4"), each = 3)

dtPlots <- rbind(data.table(Level = 1, Header = "Concentration Time  Profiles"),
  data.table(Level = 2, Header = "Studies used for Model building."),
  dtPlots,
  data.table(Level = 2, Header = "Studies used for Model Validation."),
  dtPlots2,
  fill = TRUE
)

for (col in names(dtPlots)) {
  dtPlots[[col]][is.na(dtPlots[[col]])] <- ""
}

knitr::kable(dtPlots)
```

### Conclusion
Filling out the Excel configuration sheet correctly is crucial for generating accurate and informative time profile panels. By following this guide, you can ensure that your plots are well-defined and ready for analysis. 

If you have any questions or need further assistance, please refer to the package documentation or reach out to the support team.



